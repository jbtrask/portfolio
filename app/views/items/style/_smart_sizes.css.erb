<% 
	def space(length, percent, min = 0)
		space = (length.to_f * percent.to_f / 100.0).floor
		space < min.to_i ? min.to_i : space
		space	
	end

	def corrected_length(content_length, content_percent)
		(content_length.to_f / (content_percent.to_f / 100.0)).ceil
	end

	def layout_info(size, rows, columns, horizontal_content, vertical_content)
		info = {}
		info[:size] = size
		info[:rows] = rows
		info[:columns] = columns
		info[:grid_width_space] = space(size[:width], GRID_PADDING, MIN_GRID_SPACE)
		info[:grid_height_space] = space(size[:height], GRID_PADDING, MIN_GRID_SPACE)
		info[:matrix_width] = columns * size[:width] + (columns - 1) * info[:grid_width_space]
		info[:matrix_height] = rows * size[:height] + (rows - 1) * info[:grid_height_space]
		info[:matrix_width_space] = space(info[:matrix_width], MATRIX_PADDING, MIN_MATRIX_SPACE) 		
		info[:matrix_height_space] = space(info[:matrix_height], MATRIX_PADDING, MIN_MATRIX_SPACE)
		info[:required_width] = info[:matrix_width] + 2 * info[:matrix_width_space]
		info[:required_height] = info[:matrix_height] + 2 * info[:matrix_height_space]
		info[:corrected_required_width] = corrected_length(info[:required_width], horizontal_content)
		info[:corrected_required_height] = corrected_length(info[:required_height], vertical_content)
		info
	end

	sizes = (GRID_MIN / GRID_INCREMENT..GRID_MAX / GRID_INCREMENT).inject([]) do |memo, value|
		memo << { :width => value * GRID_INCREMENT, :height => ((value * GRID_INCREMENT).to_f * GRID_ASPECT_RATIO).round }
	end

	queries = sizes.inject([])  do |list, size|
		layout = layout_info(size, rows, columns, horizontal_content, vertical_content) 
		list << 
		{ 
			:query => "only screen" + 
				(size == sizes.first ? "" : " and (min-height: " + layout[:corrected_required_height].to_s + "px)") + 
				(size == sizes.first ? "" : " and (min-width: " + layout[:corrected_required_width].to_s + "px)"), 
			:layout => layout 
		}
	end

	right_list = not_right_list = bottom_list = not_bottom_list = ""
	(0..CELL_COUNT  - 1).each do |i|
		right_list += (right_list == "" ? "" : ", ") + "li#grid_cell_" + i.to_s if (i + 1) % columns == 0
		not_right_list += (not_right_list == "" ? "" : ", ") + "li#grid_cell_" + i.to_s if (i + 1) % columns != 0
		bottom_list += (bottom_list == "" ? "" : ", ") + "li#grid_cell_" + i.to_s if ((i + 1).to_f / columns.to_f).ceil % rows == 0
		not_bottom_list += (not_bottom_list == "" ? "" : ", ") + "li#grid_cell_" + i.to_s if ((i + 1).to_f / columns.to_f).ceil % rows != 0 
	end
%>
<%= right_list %> {
	margin-right: 0
}
<%= bottom_list %> {
	margin-bottom: 0
}
<%	
	queries.each do |query|
		layout = query[:layout]
%>
@media <%= query[:query] %> {

	#h-size:after {
		content: "width:  <%= layout[:size][:width] %> (<%= query[:layout][:columns] %>)"
	}

	#v-size:after {
		content: "height:  <%= layout[:size][:height] %> (<%= query[:layout][:rows] %>)"
	}

	div#main ul {
		width: <%=layout[:matrix_width] %>px;
		min-width: <%= layout[:matrix_width] %>px;
		height: <%= layout[:matrix_height] %>px;
		min-height: <%= layout[:matrix_height] %>px;
	}

	.grid_cell {
		width: <%= layout[:size][:width] %>px;
		min-width: <%= layout[:size][:width] %>px;
		height: <%= layout[:size][:height] %>px;
		min-height: <%= layout[:size][:height] %>px;
		margin: 0 <%= layout[:grid_width_space] %>px <%= layout[:grid_height_space] %>px 0;
	}

	<%= not_right_list %> {
		margin-right: <%= layout[:grid_width_space] %>px;
	}
	<%= not_bottom_list %> {
		margin-bottom: <%= layout[:grid_height_space] %>px;
	}
}		
<%	
	end
%>
